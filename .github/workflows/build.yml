name: Build VGPU (APK)

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  build-and-repack:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Android SDK Tools
      uses: android-actions/setup-android@v3

    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      id: setup-ndk
      with:
        ndk-version: r27c

    - name: Build Native Library (Ninja)
      run: |
        sudo apt-get update && sudo apt-get install -y ninja-build

        export ANDROID_NDK_HOME=${{ steps.setup-ndk.outputs.ndk-path }}
        mkdir build
        cd build

        cmake .. \
          -Wno-dev \
          -DCMAKE_TOOLCHAIN_FILE="$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake" \
          -DANDROID_ABI=arm64-v8a \
          -DANDROID_PLATFORM=android-24 \
          -DCMAKE_BUILD_TYPE=Release \
          -DANDROID=ON \
          -DNO_GBM=ON \
          -G "Ninja" \
          -DCMAKE_C_FLAGS="-w -std=gnu99 -Ofast -march=armv8-a+simd -mtune=cortex-a53 -ftree-vectorize -ffast-math -funroll-loops -fomit-frame-pointer -flto -fno-math-errno -Wno-error -Wno-implicit-function-declaration" \
          -DCMAKE_SHARED_LINKER_FLAGS="-flto -fuse-ld=lld -Wl,--gc-sections"
        ninja

    - name: Inject Library & Create APK
      run: |
        if [ ! -d "base_apk" ]; then
          echo "FATAL ERROR: Folder 'base_apk' not found!"
          exit 1
        fi

        echo "Preparing workspace..."
        mkdir -p output_apk
        cp -r base_apk/* output_apk/
        mkdir -p output_apk/lib/arm64-v8a

        if [ -f build/libvgpu.so ]; then
             echo "Found libvgpu.so, injecting..."
             cp build/libvgpu.so output_apk/lib/arm64-v8a/libgl4es_3.so
        else
             echo "Build failed! Library libvgpu.so not found in build directory."
             ls -R build/
             exit 1
        fi

        rm -f output_apk/*.keystore

        cd output_apk
        zip -r ../unsigned.apk .
        cd ..

    - name: Sign APK
      run: |
        BUILD_TOOLS_VERSION=$(ls $ANDROID_HOME/build-tools | sort -V | tail -n 1)
        ZIPALIGN="$ANDROID_HOME/build-tools/$BUILD_TOOLS_VERSION/zipalign"
        APKSIGNER="$ANDROID_HOME/build-tools/$BUILD_TOOLS_VERSION/apksigner"

        $ZIPALIGN -v -p 4 unsigned.apk aligned.apk

        if [ -f base_apk/my_release.keystore ]; then
            echo "Signing with Keystore..."
            
            $APKSIGNER sign \
              --ks base_apk/my_release.keystore \
              --ks-pass pass:123456 \
              --key-pass pass:123456 \
              --ks-key-alias mykey \
              --out VGPU-r27c.apk \
              aligned.apk
              
            echo "SUCCESS: VGPU-r27c.apk file successfully created!"
        else
            echo "ERROR: File 'my_release.keystore' does not exist in base_apk folder!"
            echo "Please upload the keystore first for permanent signature."
            exit 1
        fi

    - name: Upload Result
      uses: actions/upload-artifact@v4
      with:
        name: VGPU-r27c-APK
        path: VGPU-r27c.apk