name: Build VGPU & Repack APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-repack:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Android SDK Tools
      uses: android-actions/setup-android@v3

    # Tetap gunakan r21e karena VGPU kode lama. r27c akan membuat kode 5 tahun lalu error.
    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      id: setup-ndk
      with:
        ndk-version: r21e

    - name: Build Native Library (VGPU)
      run: |
        echo "Starting VGPU Build..."
        # Kita menyuntikkan flags optimasi ala kamu ke dalam APP_CFLAGS
        ${{ steps.setup-ndk.outputs.ndk-path }}/ndk-build \
          NDK_PROJECT_PATH=. \
          APP_BUILD_SCRIPT=Android.mk \
          APP_ABI=arm64-v8a \
          APP_CFLAGS="-Ofast -march=armv8-a+simd -mtune=cortex-a53 -ftree-vectorize -ffast-math -funroll-loops -fomit-frame-pointer -flto -fno-math-errno"

    - name: Inject Library & Create APK
      run: |
        # Cek ketersediaan bahan baku APK
        if [ ! -d "base_apk" ]; then
          echo "FATAL ERROR: Folder 'base_apk' tidak ditemukan di repo!"
          echo "Kamu wajib upload folder hasil ekstrak APK target ke repo dulu."
          exit 1
        fi

        echo "Preparing workspace..."
        mkdir -p output_apk
        
        # Copy isi base_apk ke workspace
        cp -r base_apk/* output_apk/
        mkdir -p output_apk/lib/arm64-v8a

        # Logika Pencarian Library VGPU
        # VGPU output defaultnya ada di folder libs/arm64-v8a/
        if [ -f libs/arm64-v8a/libVGPU.so ]; then
             echo "Found libVGPU.so, injecting..."
             # Disini kita rename jadi libgl4es_3.so (atau nama lain sesuai target inject kamu)
             # Ubah nama tujuan di bawah ini jika perlu
             cp libs/arm64-v8a/libVGPU.so output_apk/lib/arm64-v8a/libgl4es_3.so
             
             # Opsional: Jika kamu ingin namanya tetap libVGPU.so, ganti baris atas.
        else
             echo "Build failed! Library VGPU tidak ditemukan."
             ls -R libs/
             exit 1
        fi

        # Bersihkan sisa keystore lama jika ada di base
        rm -f output_apk/*.keystore

        # Zip kembali menjadi APK
        cd output_apk
        zip -r ../unsigned.apk .
        cd ..

    - name: Sign APK
      run: |
        BUILD_TOOLS_VERSION=$(ls $ANDROID_HOME/build-tools | sort -V | tail -n 1)
        ZIPALIGN="$ANDROID_HOME/build-tools/$BUILD_TOOLS_VERSION/zipalign"
        APKSIGNER="$ANDROID_HOME/build-tools/$BUILD_TOOLS_VERSION/apksigner"

        echo "Aligning APK..."
        $ZIPALIGN -v -p 4 unsigned.apk aligned.apk

        if [ -f base_apk/my_release.keystore ]; then
            echo "Signing with Keystore..."
            
            $APKSIGNER sign \
              --ks base_apk/my_release.keystore \
              --ks-pass pass:123456 \
              --key-pass pass:123456 \
              --ks-key-alias mykey \
              --out VGPU-Repacked.apk \
              aligned.apk
              
            echo "SUCCESS: VGPU-Repacked.apk file successfully created!"
        else
            echo "ERROR: File 'my_release.keystore' tidak ada di dalam folder base_apk!"
            exit 1
        fi

    - name: Upload Result
      uses: actions/upload-artifact@v4
      with:
        name: VGPU-Mod-APK
        path: VGPU-Repacked.apk