name: Build VGPU (Modern NDK r27c + LTO)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-repack:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Android SDK Tools
      uses: android-actions/setup-android@v3

    # UPGRADE: Menggunakan NDK r27c (Bleeding Edge)
    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      id: setup-ndk
      with:
        ndk-version: r27c

    - name: Build Native Library (VGPU)
      run: |
        echo "Starting VGPU Build with NDK r27c & LTO..."
        
        # Bersihkan build sebelumnya
        ${{ steps.setup-ndk.outputs.ndk-path }}/ndk-build clean NDK_PROJECT_PATH=. APP_BUILD_SCRIPT=Android.mk

        # BUILD COMMAND
        # Penjelasan Flag Keras:
        # -flto=thin     : Versi LTO yang lebih cepat dan stabil untuk Android modern.
        # -fuse-ld=lld   : WAJIB ADA jika pakai LTO! Memaksa pakai linker LLVM (lld).
        # -Wno-error     : Jangan stop build cuma gara-gara warning (kode tua banyak warningnya).
        
        ${{ steps.setup-ndk.outputs.ndk-path }}/ndk-build \
          NDK_PROJECT_PATH=. \
          APP_BUILD_SCRIPT=Android.mk \
          APP_ABI=arm64-v8a \
          APP_CFLAGS="-std=gnu99 -Ofast -flto -march=armv8-a+simd -mtune=cortex-a53 -ftree-vectorize -ffast-math -funroll-loops -fomit-frame-pointer -fno-math-errno -Wno-error -Wno-implicit-function-declaration -Wno-error=implicit-function-declaration -Wno-incompatible-function-pointer-types" \
          APP_LDFLAGS="-flto -fuse-ld=lld -Wl,--gc-sections"

    - name: Inject Library & Create APK
      run: |
        if [ ! -d "base_apk" ]; then
          echo "FATAL ERROR: Folder 'base_apk' tidak ditemukan!"
          exit 1
        fi

        echo "Preparing workspace..."
        mkdir -p output_apk
        cp -r base_apk/* output_apk/
        mkdir -p output_apk/lib/arm64-v8a

        # Deteksi Library (Lowercase vs Uppercase)
        if [ -f libs/arm64-v8a/libvgpu.so ]; then
             echo "Found libvgpu.so, injecting..."
             cp libs/arm64-v8a/libvgpu.so output_apk/lib/arm64-v8a/libgl4es_3.so
             
        elif [ -f libs/arm64-v8a/libVGPU.so ]; then
             echo "Found libVGPU.so, injecting..."
             cp libs/arm64-v8a/libVGPU.so output_apk/lib/arm64-v8a/libgl4es_3.so
             
        else
             echo "Build failed! Library tidak ditemukan."
             ls -R libs/
             exit 1
        fi

        rm -f output_apk/*.keystore
        cd output_apk
        zip -r ../unsigned.apk .
        cd ..

    - name: Sign APK
      run: |
        BUILD_TOOLS_VERSION=$(ls $ANDROID_HOME/build-tools | sort -V | tail -n 1)
        ZIPALIGN="$ANDROID_HOME/build-tools/$BUILD_TOOLS_VERSION/zipalign"
        APKSIGNER="$ANDROID_HOME/build-tools/$BUILD_TOOLS_VERSION/apksigner"

        $ZIPALIGN -v -p 4 unsigned.apk aligned.apk

        if [ -f base_apk/my_release.keystore ]; then
            echo "Signing..."
            $APKSIGNER sign \
              --ks base_apk/my_release.keystore \
              --ks-pass pass:123456 \
              --key-pass pass:123456 \
              --ks-key-alias mykey \
              --out VGPU-r27c-LTO.apk \
              aligned.apk
            echo "SUCCESS: APK Created!"
        else
            echo "ERROR: Keystore missing!"
            exit 1
        fi

    - name: Upload Result
      uses: actions/upload-artifact@v4
      with:
        name: VGPU-NextGen-APK
        path: VGPU-r27c-LTO.apk